# API Documentation - Controll IT Help Desk## Visão GeralA API do Sistema Help Desk Controll IT é uma API RESTful desenvolvida em PHP que fornece endpoints para autenticação, gerenciamento de chamados, usuários e relatórios.**Base URL:** `https://seudominio.com/api/`## AutenticaçãoA API utiliza JWT (JSON Web Token) para autenticação. Inclua o token no header `Authorization`:```Authorization: Bearer <seu_token_jwt>```### Obter Token de Acesso**POST** `/auth/login`**Body:**```json{  "username": "usuario",  "password": "senha123"}```**Response:**```json{  "success": true,  "message": "Login realizado com sucesso",  "data": {    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",    "user": {      "id": 1,      "name": "Usuário Padrão",      "email": "usuario@controllit.com.br",      "username": "usuario",      "user_type": "user",      "active": true,      "created_at": "2024-01-01 10:00:00"    }  }}```### Renovar Token**GET** `/auth/refresh`**Headers:** `Authorization: Bearer <token>`### Logout**GET** `/auth/logout`**Headers:** `Authorization: Bearer <token>`### Perfil do Usuário**GET** `/auth/profile`**Headers:** `Authorization: Bearer <token>`## Endpoints de Chamados### Listar Chamados**GET** `/tickets`**Query Parameters:**- `page` (opcional): Número da página (padrão: 1)- `limit` (opcional): Itens por página (padrão: 20)- `status` (opcional): Filtrar por status (aberto, em_andamento, fechado)- `priority` (opcional): Filtrar por prioridade (Baixa, Média, Alta, Crítica)- `category` (opcional): Filtrar por categoria- `user_id` (opcional): Filtrar por usuário (apenas admin)- `assigned_to` (opcional): Filtrar por agente atribuído**Response:**```json{  "success": true,  "message": "Chamados carregados com sucesso",  "data": {    "tickets": [      {        "id": 1,        "title": "Problema com impressora",        "description": "A impressora não está funcionando...",        "created_at": "2024-01-01 10:00:00",        "updated_at": "2024-01-01 10:00:00",        "closed_at": null,        "user_name": "Usuário Padrão",        "user_email": "usuario@controllit.com.br",        "assigned_to_name": "Agente de Suporte",        "assigned_to_email": "suporte@controllit.com.br",        "category_name": "Hardware",        "priority_name": "Média",        "priority_level": 2,        "priority_color": "#f59e0b",        "status_name": "Aberto",        "status_slug": "aberto",        "status_color": "#f59e0b",        "resolution_time_hours": null      }    ],    "pagination": {      "page": 1,      "limit": 20,      "total": 50,      "pages": 3    }  }}```### Visualizar Chamado**GET** `/tickets/{id}`**Headers:** `Authorization: Bearer <token>`**Response:**```json{  "success": true,  "message": "Chamado carregado com sucesso",  "data": {    "id": 1,    "title": "Problema com impressora",    "description": "A impressora não está funcionando corretamente...",    "category_id": 1,    "priority_id": 2,    "status_id": 1,    "user_id": 1,    "assigned_to": 2,    "created_at": "2024-01-01 10:00:00",    "updated_at": "2024-01-01 10:00:00",    "closed_at": null,    "user_name": "Usuário Padrão",    "assigned_to_name": "Agente de Suporte",    "category_name": "Hardware",    "priority_name": "Média",    "status_name": "Aberto",    "comments": [      {        "id": 1,        "comment": "Chamado aberto pelo usuário",        "is_internal": false,        "created_at": "2024-01-01 10:00:00",        "user_name": "Usuário Padrão"      }    ],    "history": [      {        "id": 1,        "field_name": "status_id",        "old_value": "1",        "new_value": "2",        "created_at": "2024-01-01 11:00:00",        "user_name": "Agente de Suporte"      }    ]  }}```### Criar Chamado**POST** `/tickets`**Headers:** `Authorization: Bearer <token>`**Body:**```json{  "title": "Novo problema",  "description": "Descrição detalhada do problema",  "category_id": 1,  "priority_id": 2}```### Atualizar Chamado**PUT** `/tickets/{id}`**Headers:** `Authorization: Bearer <token>`**Body:**```json{  "title": "Título atualizado",  "description": "Descrição atualizada",  "priority_id": 3,  "status_id": 2,  "assigned_to": 2}```### Excluir Chamado**DELETE** `/tickets/{id}`**Headers:** `Authorization: Bearer <token>`**Permissão:** Apenas administradores### Adicionar Comentário**POST** `/tickets/{id}/comment`**Headers:** `Authorization: Bearer <token>`**Body:**```json{  "comment": "Comentário sobre o chamado",  "is_internal": false}```### Estatísticas de Chamados**GET** `/tickets/stats`**Headers:** `Authorization: Bearer <token>`**Response (Usuário):**```json{  "success": true,  "message": "Estatísticas carregadas com sucesso",  "data": {    "total": 10,    "open": 3,    "in_progress": 2,    "closed": 5  }}```**Response (Suporte):**```json{  "success": true,  "message": "Estatísticas carregadas com sucesso",  "data": {    "open_tickets": 15,    "assigned_to_me": 8,    "in_progress": 3,    "closed": 12  }}```**Response (Admin):**```json{  "success": true,  "message": "Estatísticas carregadas com sucesso",  "data": {    "total_tickets": 150,    "total_users": 25,    "support_users": 5,    "avg_resolution_time": 24.5  }}```## Endpoints de Usuários### Listar Usuários**GET** `/users`**Headers:** `Authorization: Bearer <token>`**Permissão:** Apenas administradores**Query Parameters:**- `page` (opcional): Número da página- `limit` (opcional): Itens por página- `type` (opcional): Filtrar por tipo (user, support, admin)- `active` (opcional): Filtrar por status ativo (0 ou 1)### Visualizar Usuário**GET** `/users/{id}`**Headers:** `Authorization: Bearer <token>`### Criar Usuário**POST** `/users`**Headers:** `Authorization: Bearer <token>`**Permissão:** Apenas administradores**Body:**```json{  "name": "Nome do Usuário",  "email": "email@controllit.com.br",  "password": "senha123",  "user_type": "user"}```### Atualizar Usuário**PUT** `/users/{id}`**Headers:** `Authorization: Bearer <token>`**Body:**```json{  "name": "Nome Atualizado",  "email": "novoemail@controllit.com.br",  "user_type": "support",  "active": true}```### Excluir Usuário**DELETE** `/users/{id}`**Headers:** `Authorization: Bearer <token>`**Permissão:** Apenas administradores### Alternar Status do Usuário**POST** `/users/{id}/toggle-status`**Headers:** `Authorization: Bearer <token>`**Permissão:** Apenas administradores### Listar Agentes de Suporte**GET** `/users/support-agents`**Headers:** `Authorization: Bearer <token>`**Permissão:** Apenas administradores### Estatísticas de Usuários**GET** `/users/stats`**Headers:** `Authorization: Bearer <token>`**Permissão:** Apenas administradores## Endpoints de Relatórios (Dashboard)### Gráfico de Status**GET** `/dashboard/status-chart`**Headers:** `Authorization: Bearer <token>`**Permissão:** Administradores**Response:**```json{  "success": true,  "message": "Dados carregados com sucesso",  "data": {    "labels": ["Abertos", "Em Andamento", "Fechados"],    "values": [10, 5, 25],    "colors": ["#f59e0b", "#3b82f6", "#10b981"]  }}```### Gráfico de Prioridades**GET** `/dashboard/priority-chart`**Headers:** `Authorization: Bearer <token>`**Permissão:** Administradores### Gráfico de Agentes**GET** `/dashboard/agent-chart`**Headers:** `Authorization: Bearer <token>`**Permissão:** Administradores### Estatísticas de Resolução**GET** `/dashboard/resolution-stats`**Headers:** `Authorization: Bearer <token>`**Permissão:** Administradores**Response:**```json{  "success": true,  "message": "Estatísticas carregadas com sucesso",  "data": {    "avg": 24.5,    "min": 2.0,    "max": 168.0  }}```## Endpoints Auxiliares### Listar Categorias**GET** `/categories`**Headers:** `Authorization: Bearer <token>`**Response:**```json{  "success": true,  "message": "Categorias carregadas com sucesso",  "data": [    {      "id": 1,      "name": "Hardware",      "description": "Problemas relacionados a equipamentos físicos",      "active": true    }  ]}```### Listar Prioridades**GET** `/priorities`**Headers:** `Authorization: Bearer <token>`### Listar Status**GET** `/statuses`**Headers:** `Authorization: Bearer <token>`## Códigos de Status HTTP- **200 OK:** Requisição bem-sucedida- **201 Created:** Recurso criado com sucesso- **400 Bad Request:** Dados inválidos na requisição- **401 Unauthorized:** Token inválido ou ausente- **403 Forbidden:** Permissão insuficiente- **404 Not Found:** Recurso não encontrado- **405 Method Not Allowed:** Método HTTP não permitido- **500 Internal Server Error:** Erro interno do servidor## Estrutura de Resposta Padrão### Sucesso```json{  "success": true,  "message": "Mensagem de sucesso",  "data": { ... }}```### Erro```json{  "success": false,  "message": "Mensagem de erro",  "details": "Detalhes adicionais do erro"}```## Tipos de Usuário e Permissões### Usuário Padrão (`user`)- Criar chamados- Visualizar próprios chamados- Comentar em próprios chamados### Agente de Suporte (`support`)- Todas as permissões do usuário padrão- Visualizar todos os chamados- Atualizar status de chamados- Atribuir chamados para si mesmo- Comentar em qualquer chamado### Administrador (`admin`)- Todas as permissões do suporte- Gerenciar usuários (criar, editar, excluir)- Excluir chamados- Visualizar relatórios e estatísticas- Gerenciar configurações do sistema## Rate LimitingA API implementa rate limiting básico:- **100 requests por minuto** por IP- **1000 requests por hora** por usuário autenticado## Segurança### Headers de Segurança- **CORS:** Configurado para permitir requisições do frontend- **Content-Type:** Apenas `application/json` aceito- **Authorization:** Token JWT obrigatório para endpoints protegidos### Validação de Dados- Sanitização de inputs- Validação de tipos de dados- Verificação de permissões em cada endpoint- Log de atividades para auditoria### Logs de SegurançaTodos os acessos são registrados na tabela `access_logs` com:- IP do usuário- User Agent- Ação realizada- Recurso acessado- Status de sucesso/falha- Timestamp## Exemplos de Uso### JavaScript (Fetch API)```javascript// Loginconst loginResponse = await fetch('/api/auth/login', {  method: 'POST',  headers: {    'Content-Type': 'application/json'  },  body: JSON.stringify({    username: 'usuario',    password: 'senha123'  })});const loginData = await loginResponse.json();const token = loginData.data.token;// Listar chamadosconst ticketsResponse = await fetch('/api/tickets', {  headers: {    'Authorization': `Bearer ${token}`  }});const ticketsData = await ticketsResponse.json();console.log(ticketsData.data.tickets);```### PHP (cURL)```php// Login$loginData = [    'username' => 'usuario',    'password' => 'senha123'];$ch = curl_init();curl_setopt($ch, CURLOPT_URL, 'https://seudominio.com/api/auth/login');curl_setopt($ch, CURLOPT_POST, 1);curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($loginData));curl_setopt($ch, CURLOPT_HTTPHEADER, [    'Content-Type: application/json']);curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);$response = curl_exec($ch);$data = json_decode($response, true);$token = $data['data']['token'];curl_close($ch);// Listar chamados$ch = curl_init();curl_setopt($ch, CURLOPT_URL, 'https://seudominio.com/api/tickets');curl_setopt($ch, CURLOPT_HTTPHEADER, [    'Authorization: Bearer ' . $token]);curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);$response = curl_exec($ch);$tickets = json_decode($response, true);curl_close($ch);```## Troubleshooting### Problemas Comuns1. **Token Expirado (401)**   - Use o endpoint `/auth/refresh` para renovar o token   - Implemente refresh automático no frontend2. **Permissão Negada (403)**   - Verifique se o usuário tem o tipo correto   - Confirme se o endpoint requer permissão específica3. **Dados Inválidos (400)**   - Verifique a estrutura do JSON   - Confirme se todos os campos obrigatórios foram enviados   - Valide tipos de dados (ex: IDs devem ser números)4. **Recurso Não Encontrado (404)**   - Verifique se o ID existe   - Confirme se o endpoint está correto### Logs de DebugPara debug, verifique os logs do servidor web e a tabela `access_logs` no banco de dados.## Changelog### v1.0.0 (2024-01-01)- Versão inicial da API- Autenticação JWT- CRUD completo de chamados e usuários- Sistema de permissões- Relatórios e estatísticas- Logs de auditoria